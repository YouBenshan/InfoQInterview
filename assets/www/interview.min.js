var S_APP_NAME="InfoQInterview";var S_REMOTE_INTERVIEW_LIST_URL="http://www.jpcxc.com/test/list.en.txt";var S_REMOTE_INTERVIEW_LIST_NAME="list.en.txt";var S_LOCK_FILE_NAME="lock.txt";var oDataDir;var listview;var listFooter;function onConfirm(button){if(button===1){navigator.app.exitApp()}}function onBackKeyDown(){if($.mobile.activePage.is("#list")){navigator.notification.confirm("Are You Sure?",onConfirm,"Log Out!","")}else{navigator.app.backHistory()}}function onFileSystemSuccess(fileSystem){fileSystem.root.getDirectory(S_APP_NAME,{create:true,exclusive:false},function(parent){oDataDir=parent;lister.showLocalIntervews();lister.clean()})}function onDeviceReady(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,onFileSystemSuccess);document.addEventListener("backbutton",onBackKeyDown,false)}document.addEventListener("deviceready",onDeviceReady);$("#list").live("pageinit",function(event){listview=$("#list").children(":jqmData(role=content)").children(":jqmData(role=listview)");listFooter=$("#list").children(":jqmData(role=footer)")});$(document).on("mobileinit",function(){$.mobile.allowCrossDomainPages=true;$.mobile.buttonMarkup.hoverDelay(0);$.mobile.pushStateEnabled(false)});var utils={};utils.getFileUrl=function(sServerPrifix,sId){return sServerPrifix+sId};utils.getFilePath=function(sName,sType){return oDataDir.fullPath+"/"+sName+"/"+sName+"."+sType};utils.getJson=function(oFileEntry){var oJson;var reader=new FileReader;reader.onloadend=function(evt){oJson=JSON.parse(evt.target.result)};reader.readAsText(oFileEntry);reader.abort();return oJson};utils.playInterview=function(sInterviewName){player.setInterview(sInterviewName);player.playtMp3()};utils.removeFile=function(file){file.remove()};var player={};player.qaIndex=0;player.interviewName=undefined;player.line=undefined;player.mp3=undefined;player.interval=undefined;player.setInterview=function(sInterviewName){if(this.mp3!==undefined){this.pauseMp3();this.mp3.stop();this.mp3.release()}player.interviewName=sInterviewName;player.showTitle(player.interviewName);player.initMp3(player.interviewName);oDataDir.getFile(player.interviewName+"/"+player.interviewName+".txt",{create:false,exclusive:false},function(oLineFileEntry){player.line=utils.getJson(oLineFileEntry);player.qaIndex=0;player.showLine()})};player.initMp3=function(sInterviewName){this.mp3=new Media(oDataDir.fullPath+"/"+sInterviewName+"/"+sInterviewName+".mp3")};player.nextQa=function(){if(this.qaIndex<this.line.qas.length-1){this.qaIndex++}this.showLine();this.mp3.seekTo(1e3*this.line.qas[this.qaIndex].t-500)};player.preQa=function(){if(this.qaIndex>0){this.qaIndex--}this.showLine();this.mp3.seekTo(1e3*this.line.qas[this.qaIndex].t-500)};player.preTime=function(){this.mp3.getCurrentPosition(function(position){if(position>5+player.line.qas[0].t){player.mp3.seekTo((position-5)*1e3)}})};player.nextTime=function(){this.mp3.getCurrentPosition(function(position){player.mp3.seekTo((position+5)*1e3)})};player.showLine=function(){var markup="<b><i>("+(this.qaIndex+1)+"/"+this.line.qas.length+")</i>"+this.line.qas[this.qaIndex].q+"</b><p>"+this.line.qas[this.qaIndex].a+"</p>";$("#player").children(":jqmData(role=content)").html(markup);$.mobile.silentScroll(0)};player.showTitle=function(sInterviewName){$("#player").children(":jqmData(role=header)").children("h6").html(sInterviewName)};player.pauseMp3=function(){this.mp3.pause();$("#playPauseButton").buttonMarkup({icon:"play"});$("#playPauseButton").find(".ui-btn-text").text("Play");$("#playPauseButton").attr("ontouchstart","player.playtMp3();");this.intervalCheckPause()};player.playtMp3=function(){this.mp3.play();$("#playPauseButton").buttonMarkup({icon:"pause"});$("#playPauseButton").find(".ui-btn-text").text("Pause");$("#playPauseButton").attr("ontouchstart","player.pauseMp3();");this.intervalCheckStart()};player.intervalCheckStart=function(){this.interval=setInterval(function(){player.mp3.getCurrentPosition(function(position){if(player.qaIndex===player.line.qas.length-1&&position<=0){player.setInterview(player.interviewName)}else if(position>player.line.qas[player.qaIndex+1].t-1){player.qaIndex++;player.showLine()}else if(position<player.line.qas[player.qaIndex].t&&player.qaIndex>0){player.qaIndex--;player.showLine()}})},1e3)};player.intervalCheckPause=function(){clearInterval(this.interval)};var synchronizer={};synchronizer.sServerPrifix="";synchronizer.sync=function(){synchronizer.showSyncStart();this.updateList(this.downloadInterviews)};synchronizer.updateList=function(fUpdated){function getNewInterviewList(oListFileEntry){var oInterviewList=utils.getJson(oListFileEntry);synchronizer.sServerPrifix=oInterviewList.prefix;var aNewInterviews=synchronizer.signOldAndGetNew(oInterviewList);fUpdated(aNewInterviews)}function checkListFile(bakFileEntry){bakFileEntry.file(function(file){if(file.size>0){getNewInterviewList(bakFileEntry);bakFileEntry.getParent(function(parent){bakFileEntry.moveTo(parent,S_REMOTE_INTERVIEW_LIST_NAME,function(){bakFileEntry.remove()})})}else{synchronizer.showNetworkError();bakFileEntry.remove()}})}var oFileTransfer=new FileTransfer;oFileTransfer.download(S_REMOTE_INTERVIEW_LIST_URL,oDataDir.fullPath+"/"+S_REMOTE_INTERVIEW_LIST_NAME+".bak",checkListFile,synchronizer.downloadError)};synchronizer.signOldAndGetNew=function(oInterviewList){var aNames=[];listview.find("h3").each(function(index,e){aNames.push($(this).text())});var aNewInterviews=[];var aToKeepedNames=[];for(var i=0;i<oInterviewList.interviews.length;i++){var sName=oInterviewList.interviews[i].name;if(jQuery.inArray(sName,aNames)<0){aNewInterviews.unshift(oInterviewList.interviews[i])}else{aToKeepedNames.push(sName)}}for(var j=0;j<aNames.length;j++){if(jQuery.inArray(aNames[j],aToKeepedNames)<0){oDataDir.getFile(aNames[j]+"/"+S_LOCK_FILE_NAME,{create:false,exclusive:false},utils.removeFile)}}return aNewInterviews};synchronizer.downloadInterviews=function(aInterviews){var oInterview;var oFileTransfer=new FileTransfer;oFileTransfer.onprogress=function(oProgressEvent){if(oProgressEvent.lengthComputable){synchronizer.showStatus(oInterview.name,oProgressEvent.total,oProgressEvent.loaded)}};function downloadInterview(){function downloadFile(sId,sType,fScceeded){function doDownloadFile(){oFileTransfer.download(utils.getFileUrl(synchronizer.sServerPrifix,sId),utils.getFilePath(oInterview.name,sType),fScceeded,synchronizer.downloadError)}return doDownloadFile}function interviewDownloaded(oInfoFile){oDataDir.getFile(oInterview.name+"/"+S_LOCK_FILE_NAME,{create:true,exclusive:false});lister.showInterviewByFile(oInfoFile);downloadInterview()}oInterview=aInterviews.pop();if(oInterview!==undefined){var fDownloadInfo=downloadFile(oInterview.info,"inf",interviewDownloaded);var fDownloadLine=downloadFile(oInterview.line,"txt",fDownloadInfo);var fDownloadPic=downloadFile(oInterview.pic,"jpg",fDownloadLine);var fDownloadMp3=downloadFile(oInterview.mp3,"mp3",fDownloadPic);fDownloadMp3()}else{synchronizer.showSyncSuccess()}}downloadInterview()};synchronizer.showStatus=function(interviewName,total,loaded){listFooter.html(interviewName+": "+(loaded>>10)+"K of "+(total>>10)+"K")};synchronizer.showSyncStart=function(){$("#syncButton").button("disable");listFooter.html("Start to Synchronize...")};synchronizer.showSyncSuccess=function(){$("#syncButton").button("enable");listFooter.html("Congratulations: All is up to date!")};synchronizer.enableSyncButton=function(){$("#syncButton").button("enable")};synchronizer.showNetworkError=function(){listFooter.html('<div style="color:yellow;">Internet is not connected!</div>')};synchronizer.showServerError=function(){listFooter.html('<div style="color:yellow;">Server is too busy. Please try again 3 minutes later</div>')};synchronizer.clearNetworkError=function(){$("#networkError").popup("close");listFooter.html("")};synchronizer.downloadError=function(oError){if(FileTransferError.CONNECTION_ERR===oError.code){synchronizer.showNetworkError()}else{synchronizer.showServerError()}synchronizer.enableSyncButton()};var lister={};lister.showLocalIntervews=function(){oDataDir.getFile(S_REMOTE_INTERVIEW_LIST_NAME,{create:false,exclusive:false},function(oListFileEntry){var oInterviewList=utils.getJson(oListFileEntry);for(var i=0;i<oInterviewList.interviews.length;i++){var sName=oInterviewList.interviews[i].name;lister.showInterviewByName(sName)}},function(){$("#noListFile").popup("open")})};lister.clean=function(){var oDataDirReader=oDataDir.createReader();oDataDirReader.readEntries(function(entries){for(var i=0;i<entries.length;i++){if(entries[i].isDirectory){lister.cleanDir(entries[i])}}})};lister.cleanDir=function(oDirectoryEntry){oDirectoryEntry.getFile(S_LOCK_FILE_NAME,{create:false,exclusive:false},function(){},function(){oDirectoryEntry.removeRecursively()})};lister.showInterviewByName=function(sName){oDataDir.getFile(sName+"/"+S_LOCK_FILE_NAME,{create:false,exclusive:false},function(){oDataDir.getFile(sName+"/"+sName+".inf",{create:false,exclusive:false},function(oInfoFileEntry){lister.showInterviewByFile(oInfoFileEntry)})})};lister.showInterviewByFile=function(oInfoFileEntry){var oInfo=utils.getJson(oInfoFileEntry);var sInterviewLi='<li data-theme="b"><a href="#player" onclick="utils.playInterview(\''+oInfo.name+'\')"><img src="'+utils.getFilePath(oInfo.name,"jpg")+'"></img><h3>'+oInfo.name+"</h3><p>"+oInfo.author+"</p><p>"+oInfo.time+'</p></a><a data-icon="page" onclick="lister.showInfo(\''+oInfo.name+"')\"></a></li>";listview.prepend(sInterviewLi);listview.listview("refresh")};lister.showInfo=function(sInterviewName){oDataDir.getFile(sInterviewName+"/"+sInterviewName+".inf",{create:false,exclusive:false},function(oInfoFileEntry){var oInfo=utils.getJson(oInfoFileEntry);$("#interviewInfo").children(":jqmData(role=header)").children("p").html(oInfo.fullName);$("#interviewInfo").children(":jqmData(role=content)").children("p").html(oInfo.desc);$("#interviewInfo").popup("open")})};